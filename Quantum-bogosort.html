<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>量子ボゴソート (Quantum Bogosort) 可視化デモ</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#121a35;--ink:#e6ecff;--muted:#9fb1ff;--accent:#7c9dff;--good:#39d98a;--bad:#ff7b7b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#1a245a22,transparent),var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    header{padding:20px 24px;border-bottom:1px solid #ffffff1a;background:linear-gradient(180deg,#ffffff08,#0000)}
    h1{margin:0;font-size: clamp(20px,3vw,28px)}
    .app{display:grid;grid-template-columns: 360px 1fr;gap:18px;align-items:start;padding:18px}
    @media (max-width:920px){.app{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid #ffffff1a;border-radius:16px;box-shadow: 0 8px 24px #00000050;overflow:hidden}
    .panel h2{font-size:16px;letter-spacing:.02em;margin:0;padding:14px 16px;border-bottom:1px solid #ffffff12;background:#ffffff05}
    .controls{padding:14px 16px;display:grid;gap:14px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
    label{color:var(--muted)}
    input[type="number"],input[type="text"],input[type="range"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #ffffff24;background:#0d1430;color:var(--ink);outline:none}
    input[type="range"]{height:32px}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:linear-gradient(180deg,#7c9dff,#5b7df5);color:#08122c}
    .btn.ghost{background:#ffffff10;color:var(--ink);border:1px solid #ffffff20}
    .btn.warn{background:linear-gradient(180deg,#ff8b8b,#ff5b5b);color:#2b0c0c}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .viz{min-height:380px;display:grid;grid-template-rows:auto 1fr;background:linear-gradient(180deg,#0f1633,#0b112b);border-radius:16px;border:1px solid #ffffff12;overflow:hidden}
    .status{padding:12px 16px;border-bottom:1px solid #ffffff12;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .status .pill{padding:6px 10px;border-radius:999px;background:#ffffff14;color:var(--muted);font-size:12px}
    .bars{position:relative;display:flex;align-items:flex-end;gap:6px;padding:16px;height:100%}
    .bar{flex:1;background:linear-gradient(180deg,#95a7ff,#4259e6);border-radius:6px 6px 0 0;box-shadow: 0 3px 10px #0006}
    .bar.mark{outline:2px dashed #fff8}
    .log{max-height:220px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Consolas,monospace;background:#0c1433;border-top:1px solid #ffffff12;padding:10px}
    .log p{margin:.2em 0;white-space:pre-wrap}
    .kbd{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;background:#ffffff14;padding:2px 6px;border-radius:6px}
    footer{padding:14px 18px;color:#b9c6ff77}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h1>量子ボゴソート (Quantum Bogosort) 可視化デモ</h1>
  </header>

  <main class="app">
    <!-- Control Panel -->
    <section class="panel">
      <h2>コントロール</h2>
      <div class="controls">
        <div class="row">
          <label>要素数 <span class="kbd">n</span></label>
          <input id="size" type="number" min="3" max="12" value="8" />
        </div>
        <div class="row">
          <label>最大値</label>
          <input id="maxv" type="number" min="3" max="200" value="99" />
        </div>
        <div class="row">
          <label>アニメ速度</label>
          <input id="speed" type="range" min="0" max="100" value="35" />
        </div>
        <div class="btns">
          <button class="btn primary" id="btnReset">配列を生成</button>
          <button class="btn ghost" id="btnShuffle">シャッフル</button>
          <button class="btn primary" id="btnQuantum">量子ボゴソート</button>
          <button class="btn warn" id="btnBogo" title="非常に遅い場合があります (n≦8推奨)">古典ボゴソート</button>
          <button class="btn ghost" id="btnSorted">既に整列？</button>
        </div>
        <div class="inline">
          <span class="kbd">Q</span> = 量子 / <span class="kbd">B</span> = 古典 / <span class="kbd">R</span> = 生成 / <span class="kbd">S</span> = シャッフル
        </div>
      </div>
    </section>

    <!-- Visualization -->
    <section class="viz panel">
      <div class="status">
        <div>状態: <strong id="statusText">準備完了</strong></div>
        <div class="pill" id="pill">idle</div>
      </div>
      <div class="bars" id="bars"></div>
      <div class="log" id="log"></div>
    </section>
  </main>

  <footer>
    <div class="inline">
      <span>⚠️ ボゴソートはジョークアルゴリズムです。量子版は「全順列の重ね合わせ → 条件付き位相反転 → 観測で整列列だけ残る」という<em>設定</em>をアニメで見せ、実装は <code>sort()</code> で結果を即時取得します。</span>
    </div>
  </footer>

<script>
(function(){
  const barsEl = document.getElementById('bars');
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('statusText');
  const pillEl = document.getElementById('pill');
  const sizeInput = document.getElementById('size');
  const maxvInput = document.getElementById('maxv');
  const speedInput = document.getElementById('speed');
  const btnReset = document.getElementById('btnReset');
  const btnShuffle = document.getElementById('btnShuffle');
  const btnQuantum = document.getElementById('btnQuantum');
  const btnBogo = document.getElementById('btnBogo');
  const btnSorted = document.getElementById('btnSorted');

  let arr = [];
  let running = false;

  const sleep = (ms)=> new Promise(res=> setTimeout(res, ms));
  const speed = ()=> 400 - (Number(speedInput.value)||0) * 3.5; // 400..50ms

  function randomArray(n,maxv){
    const a = Array.from({length:n},()=> 1+Math.floor(Math.random()*maxv));
    return a;
  }
  function isSorted(a){
    for(let i=1;i<a.length;i++) if(a[i-1] > a[i]) return false; return true;
  }
  function shuffleInPlace(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }
  function render(a){
    barsEl.innerHTML = '';
    const max = Math.max(...a);
    const min = Math.min(...a);
    a.forEach((v,i)=>{
      const el = document.createElement('div');
      el.className = 'bar';
      el.style.height = 8 + (v-min)/(max-min||1) * 240 + 'px';
      el.title = String(v);
      barsEl.appendChild(el);
    });
  }
  function setStatus(text, pill){
    statusEl.textContent = text;
    pillEl.textContent = pill;
  }
  function log(line){
    const p = document.createElement('p');
    p.textContent = line;
    logEl.appendChild(p); logEl.scrollTop = logEl.scrollHeight;
  }
  function disableControls(disabled){
    [sizeInput,maxvInput,btnReset,btnShuffle,btnQuantum,btnBogo,btnSorted].forEach(el=> el.disabled = disabled);
  }

  async function quantumBogosort(a){
    if(running) return; running = true; disableControls(true); setStatus('量子回路を初期化…','quantum'); log('▶ 初期化: |0⟩ⁿ から |arr⟩ にロード');
    await sleep(speed());

    setStatus('全順列の重ね合わせを生成…','superposition');
    log('▶ H⊗n を適用 → すべての順列が同時に存在（可視化をイメージ表示）');
    barsEl.querySelectorAll('.bar').forEach(b=> b.classList.add('mark'));
    await sleep(speed());

    setStatus('「整列済み」を検出するオラクルを適用…','oracle');
    log('▶ Oracle: f(perm) = 1 if 非減少列（整列）');
    await sleep(speed());

    setStatus('増幅→観測','measure');
    log('▶ 振幅増幅（Grover風）→ 観測で整列列だけが残る（という体）');
    await sleep(speed());

    const sorted = [...a].sort((x,y)=>x-y);
    render(sorted);
    barsEl.querySelectorAll('.bar').forEach(b=> b.classList.remove('mark'));
    setStatus('完成：整列列を観測','done');
    log('✔ 結果: ['+sorted.join(', ')+']');
    running = false; disableControls(false);
    return sorted;
  }

  async function classicalBogosort(a){
    if(a.length>8){
      alert('古典ボゴソートは n≦8 に制限しています。n を小さくしてください。');
      return;
    }
    if(running) return; running = true; disableControls(true); setStatus('古典ボゴソート実行中…','classical');
    let attempts=0; const maxAttempts= 200000; // セーフガード
    const work = [...a];
    while(!isSorted(work)){
      if(attempts%200===0){ render(work); await sleep(10+speed()/3) }
      shuffleInPlace(work); attempts++;
      if(attempts>maxAttempts){ log('⚠ 打ち切り: 試行回数上限 '+maxAttempts+' に達しました'); break; }
    }
    render(work);
    setStatus(isSorted(work)?`整列成功 (${attempts} 回シャッフル)`:`打ち切り (${attempts} 回)`,'done');
    log((isSorted(work)?'✔':'✖')+` 古典結果: [${work.join(', ')}] / 試行 ${attempts}`);
    running = false; disableControls(false);
    return work;
  }

  function regen(){
    const n = Math.min(12, Math.max(3, Number(sizeInput.value)||8));
    const maxv = Math.min(200, Math.max(3, Number(maxvInput.value)||99));
    arr = randomArray(n,maxv);
    render(arr); setStatus('新しい配列を生成','idle'); log('---'); log('arr = ['+arr.join(', ')+']');
  }

  function shuffle(){
    shuffleInPlace(arr); render(arr); setStatus('シャッフル','idle'); log('shuffle → ['+arr.join(', ')+']');
  }

  function checkSorted(){
    const ok = isSorted(arr);
    setStatus(ok?'整列済み':'未整列', ok?'ok':'ng');
    log((ok?'✔':'✖')+' isSorted = '+ok);
  }

  // init
  regen();

  // events
  btnReset.addEventListener('click', regen);
  btnShuffle.addEventListener('click', shuffle);
  btnQuantum.addEventListener('click', ()=> quantumBogosort(arr));
  btnBogo.addEventListener('click', ()=> classicalBogosort(arr));
  btnSorted.addEventListener('click', checkSorted);

  // hotkeys
  window.addEventListener('keydown', (e)=>{
    if(e.repeat) return;
    const k = e.key.toLowerCase();
    if(k==='q') btnQuantum.click();
    else if(k==='b') btnBogo.click();
    else if(k==='r') btnReset.click();
    else if(k==='s') btnShuffle.click();
  });
})();
</script>
</body>
</html>
